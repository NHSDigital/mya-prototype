{% extends '../../layouts/layout.html' %}

{% set pageName = "Edit availability" %}

{% set groupSummary = summaries.byGroup[group.id] %}

{% block beforeContent %}
{{ backLink({
  href: '/site/' ~ site_id ~ '/availability/all',
  text: 'Back'
}) }}
{% set group = null %}
{% endblock %}

{% macro monthCalendar(dates) %}
{% for yearNumber, year in dates %}
{% for monthNumber, month in year %}

<table class="app-calendar" role="table">
  <caption>{{ (yearNumber~'-'~monthNumber~'-01') | formatDate('MMMM yyyy') }}</caption>
  <thead>
    <tr>
      <th scope="col">Mon</th>
      <th scope="col">Tue</th>
      <th scope="col">Wed</th>
      <th scope="col">Thu</th>
      <th scope="col">Fri</th>
      <th scope="col">Sat</th>
      <th scope="col">Sun</th>
    </tr>
  </thead>
  <tbody>
    {% for week in month.weeks %}
    <tr>
      {% for day in week -%}

        {# calculate the logic for this table #}
        {% set thisDate = yearNumber~'-'~monthNumber | padZero~'-'~day.day | padZero %}
        {% set totalBooked = 0 %}
        {% set totalSlots = 0 %}


        {% for slot in slots[thisDate] %}
          {% set totalSlots = totalSlots + 1 %}
          {% if slot.booking_status == 'scheduled' %}
            {% set totalBooked = totalBooked + 1 %}
          {% endif %}
        {% endfor %}

        {% set classes -%}
        {%- if not day %} app-calendar-day--blank{% endif -%}
        {%- if day.hasEntry %} app-calendar-day--available{% endif -%}
        {%- if thisDate | isDateInPast(today) %} app-calendar-day--past{% endif -%}
        {%- endset %}

        <td role="gridcell" class="app-calendar-day {{ classes }}" aria-label="{{ thisDate | formatDate('cccc, d MMMM yyyy') }}" {% if thisday == today %}aria-current="date"{% endif %}>
          {% if not thisDate | isDateInPast(today) %}
          {% if day.hasEntry %}
            <a href="/site/{{ site_id }}/availability/day?date={{ thisDate }}" 
              class="app-calendar-link"
              aria-label="View availability for {{ thisDate | formatDate('cccc, d MMMM yyyy') }}">
            <span class="app-calendar-day__dayNumber">{{ day.day }}</span>
            </a>
            <ul class="app-calendar-details">
            {% if totalBooked > 0 %}
              <li>{{ totalBooked }}/{{ totalSlots }} booked</li>
            {% else %}
              <li>{{ totalSlots }} available</li>
            {% endif %}
            </ul>
          {% else %}
            <span class="app-calendar-day__dayNumber" aria-label="No availability on {{ thisDate | formatDate('cccc, d MMMM yyyy') }}">{{ day.day }}</span>
          {% endif %}
          {% else %}
            <span class="app-calendar-day__dayNumber" aria-label="Date in the past: {{ thisDate | formatDate('cccc, d MMMM yyyy') }}">{{ day.day }}</span>
          {% endif %}
        </td>
      {%- endfor %}
    </tr>
    {% endfor %}{# end week #}
  </tbody>
</table>
{% endfor %}{# end of month #}
{% endfor %}{# end of year #}
{% endmacro %}

{% block content %}

<div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-two-thirds">
      <h1 class="nhsuk-heading-l">{{ pageName }}</h1>

      <div class="app-summary-card">
        <div class="app-summary-card__title-wrapper">
          <h2 class="app-summary-card__title">Dates</h2>
          <a class="app-summary-card__action" href="#">Edit</a>
        </div>
        <div class="app-summary-card__content">
          <dl class="nhsuk-summary-list">
            <div class="nhsuk-summary-list__row">
              <dt class="nhsuk-summary-list__key">Start date</dt>
              <dd class="nhsuk-summary-list__value">{{ group.dates[0] | formatDate('d MMMM yyyy') }}</dd>
            </div>
            {% if group.type == 'repeating' %}
            <div class="nhsuk-summary-list__row">
              <dt class="nhsuk-summary-list__key">End date</dt>
              <dd class="nhsuk-summary-list__value">{{ group.dates[group.dates | length - 1] | formatDate('d MMMM yyyy') }}</dd>
            </div>
            {% endif %}
          </dl>
        </div>
      </div>

      <div class="app-summary-card">
        <div class="app-summary-card__title-wrapper">
          <h2 class="app-summary-card__title">Times, appointment length and vaccination spaces</h2>
          <a class="app-summary-card__action" href="/site/{{ site_id }}/change/group/{{ group.id }}/time-or-capacity">Edit</a>
        </div>
        <div class="app-summary-card__content">
          <dl class="nhsuk-summary-list">
            <div class="nhsuk-summary-list__row">
              <dt class="nhsuk-summary-list__key">Start time</dt>
              <dd class="nhsuk-summary-list__value">{{ group.session.from | nhsTime }}</dd>
            </div>
            <div class="nhsuk-summary-list__row">
              <dt class="nhsuk-summary-list__key">End date</dt>
              <dd class="nhsuk-summary-list__value">{{ group.session.until | nhsTime }}</dd>
            </div>
            <div class="nhsuk-summary-list__row">
              <dt class="nhsuk-summary-list__key">Available vaccinators or vaccination slots</dt>
              <dd class="nhsuk-summary-list__value">{{ group.session.capacity }}</dd>
            </div>
            <div class="nhsuk-summary-list__row">
              <dt class="nhsuk-summary-list__key">Appointment length</dt>
              <dd class="nhsuk-summary-list__value">{{ group.session.slotLength }}</dd>
            </div>
          </dl>
        </div>
      </div>

      <div class="app-summary-card">
        <div class="app-summary-card__title-wrapper">
          <h2 class="app-summary-card__title">Services</h2>
          <a class="app-summary-card__action" href="#">Edit</a>
        </div>
        <div class="app-summary-card__content">
          <table class="nhsuk-table">
            <thead class="nhsuk-table__head">
              <tr class="nhsuk-table__row">
                <th scope="col" class="nhsuk-table__header">Service</th>
                <th scope="col" class="nhsuk-table__header nhsuk-table__header--numeric">Bookings</th>
              </tr>
            </thead>
            <tbody class="nhsuk-table__body">
              {% for service_id in group.session.services %}
              <tr class="nhsuk-table__row">
                <td class="nhsuk-table__cell">{{ data.services[service_id].name  }}</td>
                <td class="nhsuk-table__cell nhsuk-table__cell--numeric">{{ groupSummary.bookingsPerService[service_id] }}</td></td>
              </tr>
              {% endfor %}
              <tr class="nhsuk-table__row app-table-row--total">
                <th scope="row" class="nhsuk-table__header">Booked appointments</td>
                <td class="nhsuk-table__cell nhsuk-table__cell--numeric">{{ groupSummary.bookedSlots | formatNumber }}</td></td>
              </tr>
              <tr class="nhsuk-table__row">
                <th scope="row" class="nhsuk-table__header">Available appointments</td>
                <td class="nhsuk-table__cell nhsuk-table__cell--numeric">{{ groupSummary.availableSlots | formatNumber }}</td></td>
              </tr>
              <tr class="nhsuk-table__row">
                <th scope="row" class="nhsuk-table__header">Total available and booked</td>
                <td class="nhsuk-table__cell nhsuk-table__cell--numeric">{{ groupSummary.totalSlots | formatNumber }}</td></td>
              </tr>   
            </tbody>
          </table>
        </div>
      </div>

      {% if group.type == 'repeating' %}
      <div class="app-summary-card">
        <div class="app-summary-card__title-wrapper">
          <h2 class="app-summary-card__title">Repeating pattern</h2>
          <a class="app-summary-card__action" href="#">Edit</a>
        </div>
        <div class="app-summary-card__content">
          <table class="nhsuk-table">
            <thead class="nhsuk-table__head">
              <tr class="nhsuk-table__row">
                <th scope="col" class="nhsuk-table__header">Day</th>
                <th scope="col" class="nhsuk-table__header nhsuk-table__header--numeric">Number of days with pattern</th>
              </tr>
            </thead>
            <tbody class="nhsuk-table__body">
              {% for day, count in group.weekdaySummary %}
              <tr class="nhsuk-table__row">
                <td class="nhsuk-table__cell">{{ day  }}</td>
                <td class="nhsuk-table__cell nhsuk-table__cell--numeric {% if count == 0 %}nhsuk-u-secondary-text-colour{% endif %}">{% if count == 0 %}None{% else %}{{ count }}{% endif %}</td></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          
        </div>
      </div>
      {% endif %}
      

    </div>
</div>

{% endblock %}