{% extends '../../layouts/layout.html' %}
{% from '../../components/subNavigation/subNavigation.njk' import subNavigation %}

{% set pageName = week[0] | formatDate('d LLLL') ~ ' to ' ~ week[6] | formatDate('d LLLL yyyy') %}

{% block beforeContent %}
{{ backLink({
  href: '/site/' ~ site_id,
  text: 'Back to dashboard'
}) }}
{% endblock %}

{% macro renderServicesTable(date) %}
<table class="nhsuk-table">
  <thead class="nhsuk-table__head">
    <tr class="nhsuk-table__row">
      <th scope="col" class="nhsuk-table__header">Time</th>
      <th scope="col" class="nhsuk-table__header">Services</th>
      <th scope="col" class="nhsuk-table__header">Booked</th>
      <th scope="col" class="nhsuk-table__header">Unbooked</th>
      <th scope="col" class="nhsuk-table__header">Action</th>
    </tr>
  </thead>
  <tbody class="nhsuk-table__body">
    {% for session in data.daily_availability[site_id][date].sessions %}
    {% for service in session.services %}

    {# counts for each service #}
    {% set bookedCount = 0 %}
    {% set unbookedCount = slots[date] | length %}
    {% set totalCount = slots[date] | length %}
    {% for slot in slots[date] %}
      {% if 
        slot.booking_status =='scheduled' 
        and data.bookings[site_id][slot.booking_id].service == service
        and (slot.group.start == session.from) and (slot.group.end == session.until)
      %}
      {% set bookedCount = bookedCount + 1 %}
      {% set unbookedCount = unbookedCount - 1 %}
      {% endif %}
    {% endfor %}

    <tr class="nhsuk-table__row">
      {% if loop.first %}
      <td class="nhsuk-table__cell" rowspan="{{ session.services | length }}">{{ session.from | nhsTime }} to {{ session.until | nhsTime }}</td>
      {% endif %}
      <td class="nhsuk-table__cell">{{ data.services[service].name }}</td>
      <td class="nhsuk-table__cell">{{ bookedCount }}</td>
      {% if loop.first %}
      <td class="nhsuk-table__cell" rowspan="{{ session.services | length }}">{{ unbookedCount }}</td>
      <td class="nhsuk-table__cell" rowspan="{{ session.services | length }}">Cancel</td>
      {% endif %}

    </tr>
    {% endfor %}
    {% endfor %}
  </tbody>
</table>
{% endmacro %}

{% block content %}
  <div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-full">

      <span class="nhsuk-caption-l">{{ data.sites[site_id].name }}{{ firstOfTheMonth }}</span>
      <h1 class="nhsuk-heading-l">{{ pageName }}</h1>
      {{
        subNavigation({
          items: [
            {
              text: 'Day',
              href: '/site/' ~ site_id ~ '/availability/day',
              visuallyHiddenText: "â€™s availability"
            },
            {
              text: 'Week',
              href: '/site/' ~ site_id ~ '/availability/week',
              isCurrent: true,
              visuallyHiddenText: ' availability'
            },
            {
              text: 'Month',
              href: '/site/' ~ site_id ~ '/availability/month',
              visuallyHiddenText: ' availability'
            },
            {
              text: 'All',
              href: '/site/' ~ site_id ~ '/availability/all',
              visuallyHiddenText: ' availability'
            },
            {
              text: 'Add availability',
              href: '/site/' ~ site_id ~ '/create-availability/type-of-session',
              isPrimary: true
            }
          ]
        })
      }}

      {{ pagination({
        previous: {
          labelText: previousWeek.start | formatDate('d') ~ " to " ~ previousWeek.end | formatDate('d LLL'),
          href: "/site/"~site_id~"/availability/week?date="~previousWeek.start
        },
        next: {
          labelText: nextWeek.start | formatDate('d') ~ " to " ~ nextWeek.end | formatDate('d LLL'),
          href: "/site/"~site_id~"/availability/week?date="~nextWeek.start  
        }
      }) }}
    </div>
  </div>
  <ol class="nhsuk-grid-row app-panel-list">
  {% for day in week %}
  <li class="nhsuk-grid-column-full  app-panel-list__item">

    <div class="nhsuk-table__panel-with-heading-tab">
      <h2 class="nhsuk-table__heading-tab">{{ day | formatDate('cccc, d LLLL') }}</h2>
      {% if data.daily_availability[site_id][day] %}
       {{ renderServicesTable(day) }}
      {% else %}
      <p>No availability</p>
      {% endif %}
    </div>

  </li>
  {% endfor %}
  </ol>
{% endblock %}