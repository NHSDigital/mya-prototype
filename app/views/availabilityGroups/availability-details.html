{% extends '../layouts/layout.html' %}

{% set pageName = 'Availability pattern details - ' ~ data.sites[site_id].name %}

{% block beforeContent %}
{{ backLink({
  href: '/site/' ~ site_id ~ '/availability/all',
  text: 'Back'
}) }}
{% endblock %}

{% macro monthCalendar(dates) %}
{% for yearNumber, year in dates %}
{% for monthNumber, month in year %}

<table class="app-calendar" role="table">
  <caption>Available days in {{ (yearNumber~'-'~monthNumber~'-01') | formatDate('MMM yyyy') }}</caption>
  <thead>
    <tr>
      <th scope="col">Mon</th>
      <th scope="col">Tue</th>
      <th scope="col">Wed</th>
      <th scope="col">Thu</th>
      <th scope="col">Fri</th>
      <th scope="col">Sat</th>
      <th scope="col">Sun</th>
    </tr>
  </thead>
  <tbody>
    {% for week in month.weeks %}
    <tr>
      {% for day in week %}
        <td class="app-calendar-day{% if not day %} app-calendar-day--blank{% endif %}{% if day.hasEntry %} app-calendar-day--available{% endif %}">
          {{ day.day }}<br>
          {% set todaysDate = yearNumber~'-'~monthNumber~'-'~day.day %}
          {% set totalBooked = 0 %}
          {% set totalSlots = 0 %}
          {% for slot in slots[todaysDate] %}
            {% set totalSlots = totalSlots + 1 %}
            {% if slot.booked %}
              {% set totalBooked = totalBooked + 1 %}
            {% endif %}
          {% endfor %}
          {% if totalSlots > 0 %}
            <span class="app-calendar-day__booked">{{ totalBooked }}</span>/<span class="app-calendar-day__total">{{ totalSlots }}</span> booked
          {% endif %}
        </td>
      {% endfor %}
    </tr>
    {% endfor %}{# end week #}
  </tbody>
</table>
{% endfor %}{# end of month #}
{% endfor %}{# end of year #}
{% endmacro %}

{% block content %}

<div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-full">

      <span class="nhsuk-caption-l">{{ data.sites[site_id].name }}</span>
      <h1 class="nhsuk-heading-l">{{ group.dates[0] | formatDate('d MMMM') }}{% if group.type == 'repeating' %} to {{ group.dates[group.dates | length - 1] | formatDate('d MMMM yyyy') }}{% endif %}, {{ group.session.from | nhsTime }} to {{ group.session.until | nhsTime }}</h1>

      <div class="nhsuk-button-group">
        {{ button({
          text: "Edit availability",
          classes: "nhsuk-button--secondary app-small-button"
        }) }}

        {{ button({
          text: "Delete availability",
          classes: "nhsuk-button--warning app-small-button"
        }) }}
      </div>

      <dl class="nhsuk-summary-list">
        <div class="nhsuk-summary-list__row">
          <dt class="nhsuk-summary-list__key">Services</dt>
          <dd class="nhsuk-summary-list__value">
            {% for service_id in group.session.services %}
              {% set service = data.services[service_id] %}
                {{ service.name }}{% if not loop.last %}<br>{% endif %}
            {% endfor %}
          </dd>
        </div>
        <div class="nhsuk-summary-list__row">
          <dt class="nhsuk-summary-list__key">Appointment length</dt>
          <dd class="nhsuk-summary-list__value">
            {{ group.session.slotLength }} minutes<br>
          </dd>
        </div>
        <div class="nhsuk-summary-list__row">
          <dt class="nhsuk-summary-list__key">Vaccinators or vaccination spaces</dt>
          <dd class="nhsuk-summary-list__value">{{ group.session.capacity }}</dd>
        </div>
      </dl>

    </div>
</div>


<div class="nhsuk-grid-row">
  <div class="nhsuk-grid-column-full">
    {{ monthCalendar(calendar.dates) | safe }}
  </div>
</div>

{% call details({
  summaryText: "Slots object"
}) %}
  {{ slots | prettyDump | safe }}
{% endcall %}
{% call details({
  summaryText: "Group object"
}) %}
  {{ group | prettyDump | safe }}
{% endcall %}
{% endblock %}