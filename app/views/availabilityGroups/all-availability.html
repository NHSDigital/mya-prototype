{% extends '../layouts/layout.html' %}
{% from '../components/subNavigation/subNavigation.njk' import subNavigation %}

{% set pageName = 'All availability - ' ~ data.sites[site_id].name %}

{% block beforeContent %}
{{ backLink({
  href: '/site/' + site_id,
  text: 'Back to dashboard'
}) }}
{% endblock %}

{% macro services(service_ids) %}
  {% set servicesCount = service_ids | length %}
  {% set serviceTypes = [] %}
  
  <ul class="nhsuk-list nhsuk-u-margin-bottom-0">
  {% for service_id in service_ids %}
    {% set vaccineShortcode = data.services[service_id].cohort.type ~ " " ~ data.services[service_id].vaccine %}
    {% if vaccineShortcode not in serviceTypes %}
      {% set serviceTypes = serviceTypes.concat([vaccineShortcode]) %}
      <li>{{ vaccineShortcode }}</li>
    {% endif %}
  {% endfor %}
  </ul>
{% endmacro %}

{% block content %}

<div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-full">

      <span class="nhsuk-caption-xl">{{ data.sites[site_id].name }}</span>
      <h1 class="nhsuk-heading-xl">All availability</h1>

      {{
        subNavigation({
          items: [
            {
              text: 'Today',
              href: '/site/' ~ site_id ~ '/availability/day',
              visuallyHiddenText: "â€™s availability"
            },
            {
              text: 'Week',
              href: '/site/' ~ site_id ~ '/availability/week',
              visuallyHiddenText: ' availability'
            },
            {
              text: 'Month',
              href: '/site/' ~ site_id ~ '/availability/month',
              visuallyHiddenText: ' availability'
            },
            {
              text: 'All',
              href: '/site/' ~ site_id ~ '/availability/all',
              isCurrent: true,
              visuallyHiddenText: ' availability'
            },
            {
              text: 'Add availability',
              href: '/site/' ~ site_id ~ '/create-availability/type-of-session',
              isPrimary: true
            }
          ]
        })
      }}

      {% if availabilityGroups|length == 0 %}
        <p class="nhsuk-body">There is no availability set up for this site.</p>
      {% else %}

      {% if availabilityGroups.repeating | length > 0 %}
      <table class="nhsuk-table-responsive" role="table">
        <caption class="nhsuk-table__caption">Repeating</caption>
        <thead class="nhsuk-table__head" role="rowgroup">
          <tr role="row">
            <th scope="col" class="nhsuk-table__header" role="columnheader">Dates and times</th>
            <th scope="col" class="nhsuk-table__header" role="columnheader">Services</th>
            <th scope="col" class="nhsuk-table__header" role="columnheader">Actions</th>
          </tr>
        </thead>    
        <tbody class="nhsuk-table__body">
          {% for group in availabilityGroups.repeating %}
          <tr class="nhsuk-table__row" role="row">
            <td class="nhsuk-table__cell" role="cell">
              <span class="nhsuk-table-responsive__heading" aria-hidden="true">Dates and times </span>
              {{ group.dates[0] | formatDate('dd MMM') }} to {{ group.dates[group.dates | length - 1] | formatDate('dd MMM yyyy') }}<br>
              {{ group.session.from | nhsTime }} to {{ group.session.until | nhsTime }}
            </td>
            <td class="nhsuk-table__cell" role="cell">
              <span class="nhsuk-table-responsive__heading" aria-hidden="true">Services </span>
              {{ services(group.session.services) }}
            </td>
            <td class="nhsuk-table__cell" role="cell">
              <span class="nhsuk-table-responsive__heading" aria-hidden="true">Actions </span>
              <a class="nhsuk-link" href="/site/{{ site_id }}/availability/all/{{ group.id }}">View</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% endif %}

      {% if availabilityGroups.single | length > 0 %}
      <table class="nhsuk-table-responsive" role="table">
        <caption class="nhsuk-table__caption">Single day</caption>
        <thead class="nhsuk-table__head" role="rowgroup">
          <tr role="row">
            <th scope="col" class="nhsuk-table__header" role="columnheader">Date and time</th>
            <th scope="col" class="nhsuk-table__header" role="columnheader">Services</th>
            <th scope="col" class="nhsuk-table__header" role="columnheader">Actions</th>
          </tr>
        </thead>
        <tbody class="nhsuk-table__body">
          {% for group in availabilityGroups.single %}
          <tr class="nhsuk-table__row" role="row">
            <td class="nhsuk-table__cell" role="cell">
              <span class="nhsuk-table-responsive__heading" aria-hidden="true">Date and times </span>
              {{ group.dates[0] | formatDate('cccc, dd MMM yyyy') }}<br>
              {{ group.session.from | nhsTime }} to {{ group.session.until | nhsTime }}
            </td>
            <td class="nhsuk-table__cell" role="cell">
              <span class="nhsuk-table-responsive__heading" aria-hidden="true">Services </span>
              {{ services(group.session.services) }}</td>
            <td class="nhsuk-table__cell" role="cell">
              <span class="nhsuk-table-responsive__heading" aria-hidden="true">Actions </span>
              <a class="nhsuk-link" href="#">View</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% endif %}

      {% endif %}

      </div>
  </div>

   {# {{ availabilityGroups | prettyDump | safe }} #}
{% endblock %}